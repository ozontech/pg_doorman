---
title: Основные настройки
---

# Настройки

## Формат конфигурационного файла

pg_doorman поддерживает два формата конфигурационных файлов:

* **YAML** (`.yaml`, `.yml`) - Основной и рекомендуемый формат для новых конфигураций.
* **TOML** (`.toml`) - Поддерживается для обратной совместимости с существующими конфигурациями.

Формат определяется автоматически по расширению файла. Оба формата поддерживают одинаковые параметры конфигурации и могут использоваться взаимозаменяемо.

### Пример конфигурации YAML (рекомендуется)

```yaml
general:
  host: "0.0.0.0"
  port: 6432
  admin_username: "admin"
  admin_password: "admin"

pools:
  mydb:
    server_host: "localhost"
    server_port: 5432
    pool_mode: "transaction"
    users:
      - username: "myuser"
        password: "mypassword"
        pool_size: 40
```

### Пример конфигурации TOML (устаревший)

```toml
[general]
host = "0.0.0.0"
port = 6432
admin_username = "admin"
admin_password = "admin"

[pools.mydb]
server_host = "localhost"
server_port = 5432
pool_mode = "transaction"

[[pools.mydb.users]]
username = "myuser"
password = "mypassword"
pool_size = 40
```

### Команда generate

Команда `generate` может выводить конфигурацию в любом формате. Формат определяется по расширению выходного файла. По умолчанию сгенерированный конфиг включает подробные встроенные комментарии, объясняющие каждый параметр.

```bash
# Generate YAML configuration (recommended)
pg_doorman generate --output config.yaml

# Generate TOML configuration (for backward compatibility)
pg_doorman generate --output config.toml

# Generate a complete reference config without PG connection
pg_doorman generate --reference --output config.yaml

# Generate reference config with Russian comments
pg_doorman generate --reference --ru --output config.yaml

# Generate config without comments (plain serialization)
pg_doorman generate --no-comments --output config.yaml
```

| Flag | Description |
|------|-------------|
| `--no-comments` | Disable inline comments in generated config (by default, comments are included) |
| `--reference` | Generate a complete reference config with example values, no PostgreSQL connection needed |
| `--russian-comments`, `--ru` | Generate comments in Russian for quick start guide |
| `--format`, `-f` | Output format: `yaml` (default) or `toml`. If `--output` is specified, format is auto-detected from file extension. This flag overrides auto-detection |

### Включение файлов

Включаемые файлы могут быть в любом формате, и форматы можно смешивать. Например, основной конфиг YAML может включать файлы TOML и наоборот:

```yaml
include:
  files:
    - "pools.yaml"
    - "users.toml"
```

## Человекочитаемые значения

pg_doorman поддерживает человекочитаемые форматы для значений длительности и размера в байтах, сохраняя обратную совместимость с числовыми значениями.

### Формат длительности

Значения длительности могут быть указаны как:

* **Числа**: интерпретируются как миллисекунды (напр., `5000` = 5 секунд)
* **Строка с суффиксом**:
    * `ms` - milliseconds (e.g., `"100ms"`)
    * `s` - seconds (e.g., `"5s"` = 5000 milliseconds)
    * `m` - minutes (e.g., `"5m"` = 300000 milliseconds)
    * `h` - hours (e.g., `"1h"` = 3600000 milliseconds)
    * `d` - days (e.g., `"1d"` = 86400000 milliseconds)

**Примеры:**
```yaml
general:
  # All these are equivalent (3 seconds):
  # connect_timeout: 3000      # backward compatible (milliseconds)
  # connect_timeout: "3s"      # human-readable
  # connect_timeout: "3000ms"  # explicit milliseconds
  connect_timeout: "3s"
  idle_timeout: "5m"         # 5 minutes
  server_lifetime: "1h"      # 1 hour
```

### Формат размера в байтах

Значения размера в байтах могут быть указаны как:

* **Числа**: интерпретируются как байты (напр., `1048576` = 1 МБ)
* **Строка с суффиксом** (регистронезависимо):
    * `B` - bytes (e.g., `"1024B"`)
    * `K` or `KB` - kilobytes (e.g., `"1K"` or `"1KB"` = 1024 bytes)
    * `M` or `MB` - megabytes (e.g., `"1M"` or `"1MB"` = 1048576 bytes)
    * `G` or `GB` - gigabytes (e.g., `"1G"` or `"1GB"` = 1073741824 bytes)

Примечание: Используются двоичные префиксы (1 КБ = 1024 байт, не 1000 байт).

**Примеры:**
```yaml
general:
  # All these are equivalent (256 MB):
  # max_memory_usage: 268435456  # backward compatible (bytes)
  # max_memory_usage: "256MB"    # human-readable
  # max_memory_usage: "256M"     # short form
  max_memory_usage: "256MB"
  unix_socket_buffer_size: "1MB" # 1 MB
  worker_stack_size: "8MB"       # 8 MB
```

## Основные настройки

### host

Адрес для приёма подключений (только TCP v4).

Default: `"0.0.0.0"`.

### port

Порт для приёма входящих подключений.

Default: `5432`.

### backlog

TCP backlog для входящих подключений. Значение 0 использует `max_connections` как значение TCP backlog.

Default: `0`.

### max_connections

Максимальное количество клиентов, которые могут подключиться к пулеру одновременно. При достижении лимита:

* Клиент, подключающийся без SSL, получит ошибку (код: `53300`, сообщение: `sorry, too many clients already`).
* Клиент, подключающийся через SSL, увидит сообщение о том, что сервер не поддерживает протокол SSL.

Default: `8192`.

### max_concurrent_creates

Максимальное количество серверных соединений, создаваемых одновременно для одного пула. Использует семафор для ограничения параллельного создания соединений, что значительно улучшает производительность при холодном старте и пиковых нагрузках.

Более высокие значения позволяют быстрее прогревать пул, но могут увеличить нагрузку на сервер PostgreSQL. Более низкие значения обеспечивают более плавное создание соединений.

Default: `4`.

### tls_mode

Режим TLS для входящих подключений. Может быть одним из следующих:

* `allow` - TLS-соединения разрешены, но не обязательны. pg_doorman попытается установить TLS-соединение, если клиент его запросит.
* `disable` - TLS-соединения запрещены. Все соединения будут установлены без TLS-шифрования.
* `require` - TLS-соединения обязательны. pg_doorman будет принимать только соединения с TLS-шифрованием.
* `verify-full` - TLS-соединения обязательны, и pg_doorman будет проверять клиентский сертификат. Этот режим обеспечивает наивысший уровень безопасности.

Default: `"allow"`.

### tls_ca_cert

Файл, содержащий CA-сертификат для верификации клиентского сертификата. Обязателен, когда `tls_mode` установлен в `verify-full`.

Default: `None`.

### tls_private_key

Путь к файлу приватного ключа для TLS-соединений. Обязателен для включения TLS для входящих клиентских подключений. Должен использоваться вместе с `tls_certificate`.

Default: `None`.

### tls_certificate

Путь к файлу сертификата для TLS-соединений. Обязателен для включения TLS для входящих клиентских подключений. Должен использоваться вместе с `tls_private_key`.

Default: `None`.

### tls_rate_limit_per_second

Ограничение количества одновременных попыток создания TLS-сессии.
Любое ненулевое значение означает наличие очереди, через которую клиенты должны пройти для установки TLS-соединения.
В некоторых случаях это необходимо для запуска приложения, открывающего множество соединений при старте ("горячий старт").

Default: `0`.

### daemon_pid_file

Включение этой настройки активирует режим демона. Закомментируйте, если хотите запускать pg_doorman на переднем плане с `-d`.

Default: `"/tmp/pg_doorman.pid"`.

### syslog_prog_name

Если указано, pg_doorman начинает отправлять сообщения в syslog (через /dev/log или /var/run/syslog).
Закомментируйте, если хотите выводить логи в stdout.

Default: `None`.

### log_client_connections

Логировать подключения клиентов для мониторинга.

Default: `true`.

### log_client_disconnections

Логировать отключения клиентов для мониторинга.

Default: `true`.

### worker_threads

Количество рабочих процессов (posix-потоков), асинхронно обслуживающих клиентов, что влияет на производительность pg_doorman.
Чем больше воркеров, тем быстрее работает система, но только до определённого предела (количество CPU).

Этот параметр также контролирует количество шардов во внутренних конкурентных хеш-картах (DashMap).
Количество шардов рассчитывается как `worker_threads * 4`, округлённое вверх до ближайшей степени 2 (минимум 4 шарда).
Это важно для развёртываний в Kubernetes, где определение количества CPU может быть некорректным.

Default: `4`.

### worker_cpu_affinity_pinning

Автоматически привязывать воркеры к разным CPU (man 3 cpu_set).

Default: `false`.

### tokio_global_queue_interval

[Настройки Tokio runtime](https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html#method.global_queue_interval).
Контролирует, как часто планировщик проверяет глобальную очередь задач.
Современные версии tokio хорошо справляются по умолчанию, поэтому параметр опциональный.

Default: `not set (uses tokio's default)`.

### tokio_event_interval

[Настройки Tokio runtime](https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html#method.event_interval).
Контролирует, как часто планировщик проверяет внешние события (I/O, таймеры).
Современные версии tokio хорошо справляются по умолчанию, поэтому параметр опциональный.

Default: `not set (uses tokio's default)`.

### worker_stack_size

[Настройки Tokio runtime](https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html#method.thread_stack_size).
Устанавливает размер стека для рабочих потоков.
Современные версии tokio хорошо справляются по умолчанию, поэтому параметр опциональный.

Default: `not set (uses tokio's default)`.

### max_blocking_threads

[Настройки Tokio runtime](https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html#method.max_blocking_threads).
Устанавливает максимальное количество потоков для блокирующих операций.
Современные версии tokio хорошо справляются по умолчанию, поэтому параметр опциональный.

Default: `not set (uses tokio's default)`.

### connect_timeout

Таймаут подключения к серверу в миллисекундах.

Default: `3000 (3 sec)`.

### query_wait_timeout

Максимальное время ожидания выполнения запроса в миллисекундах.

Default: `5000 (5 sec)`.

### idle_timeout

Таймаут простоя серверного соединения в миллисекундах.

Default: `300000000 (5000 min)`.

### server_lifetime

Время жизни серверного соединения в миллисекундах.

Default: `300000 (5 min)`.

### retain_connections_time

Интервал проверки и закрытия простаивающих соединений, превысивших `idle_timeout` или `server_lifetime`.
Задача retain запускается периодически с данным интервалом для очистки просроченных соединений.

Default: `30000 (30 sec)`.

### retain_connections_max

Максимальное количество простаивающих соединений, закрываемых за один цикл retain.
При значении `0` все простаивающие соединения, превысившие `idle_timeout` или `server_lifetime`, закрываются немедленно.
При положительном значении за один цикл закрывается не более указанного количества соединений по всем пулам.

Этот параметр контролирует, насколько агрессивно pg_doorman закрывает простаивающие соединения. При значении по умолчанию `3`
за один цикл закрывается до 3 соединений, обеспечивая контролируемую очистку. Для более быстрой очистки
просроченных соединений установите `0` (без ограничений).

Default: `3`.

### server_idle_check_timeout

Время простоя серверного соединения, после которого оно проверяется перед передачей клиенту.
Помогает обнаружить мёртвые соединения из-за перезапуска PostgreSQL, сетевых проблем или серверных таймаутов.

Если соединение простаивало в пуле дольше этого таймаута, pg_doorman отправит минимальный запрос (`;`)
для проверки его работоспособности перед возвратом клиенту. Если проверка не пройдена, соединение
сбрасывается и создаётся новое.

Установите `0` для отключения проверки (не рекомендуется для продакшн-окружений с возможной нестабильностью сети
или перезапусками PostgreSQL).

Default: `60s (60 seconds)`.

### server_round_robin

В режиме транзакционного пула можно выбрать, будет ли использоваться последний свободный бэкенд или следующий по порядку.
По умолчанию используется метод LRU (наименее недавно использованный), что положительно влияет на производительность.

Default: `false`.

### sync_server_parameters

Если включено, pg_doorman стремится восстановить параметры (через запрос `SET`), установленные клиентом (и application_name),
в режиме транзакций на других серверных бэкендах. По умолчанию отключено (false) из-за влияния на производительность.
Если вам нужно знать `application_name`, но вы не хотите проблем с производительностью из-за постоянных `SET`-запросов,
рассмотрите создание отдельного пула для каждого приложения с параметром `application_name` в настройках пула.

Default: `false`.

### tcp_so_linger

По умолчанию pg_doorman отправляет `RST` вместо удержания соединения.

Default: `0`.

### tcp_no_delay

TCP_NODELAY для отключения алгоритма Нагла для уменьшения задержки.

Default: `true`.

### tcp_keepalives_count

Keepalive включён по умолчанию и перезаписывает настройки ОС.

Default: `5`.

### tcp_keepalives_idle

Keepalive включён по умолчанию и перезаписывает настройки ОС.

Default: `5`.

### tcp_keepalives_interval

Интервал TCP keepalive в секундах.

Default: `5`.

### tcp_user_timeout

Устанавливает опцию сокета `TCP_USER_TIMEOUT` для клиентских соединений (в секундах). Эта опция задаёт
максимальное время, в течение которого переданные данные могут оставаться неподтверждёнными, прежде чем TCP
принудительно закроет соединение. Помогает обнаружить мёртвые клиентские соединения быстрее, чем keepalive,
когда соединение активно передаёт данные, но удалённая сторона стала недоступной.

При ненулевом значении, если данные остаются неподтверждёнными в течение этого времени, соединение будет
разорвано. Это особенно полезно для избежания задержек в 15-16 минут из-за таймаута ретрансмиссии TCP.

**Примечание:** Эта опция поддерживается только на Linux. На других ОС настройка игнорируется.

Установите `0` для отключения (используется значение ОС по умолчанию).

Default: `60`.

### unix_socket_buffer_size

Размер буфера для операций чтения и записи при подключении к PostgreSQL через unix socket.

Default: `1048576`.

### admin_username

Доступ к виртуальной базе данных администратора осуществляется через имя пользователя и пароль администратора.

Default: `"admin"`.

### admin_password

Доступ к виртуальной базе данных администратора осуществляется через имя пользователя и пароль администратора.
Пароль должен быть заменён на ваш секрет.

Default: `"admin"`.

### prepared_statements

Переключатель для включения/выключения кеширования подготовленных запросов.

Default: `true`.

### prepared_statements_cache_size

Размер кеша подготовленных запросов на уровне пула (общий для всех клиентов, подключающихся к одному пулу).
Кеш хранит соответствие хешей запросов именам переписанных подготовленных запросов.

Default: `8192`.

### client_prepared_statements_cache_size

Максимальное количество подготовленных запросов в кеше для одного клиентского соединения. Механизм защиты от
вредоносных или некорректно работающих клиентов, которые не вызывают `DEALLOCATE` и могут вызвать исчерпание памяти,
создавая неограниченное количество подготовленных запросов в долгоживущих соединениях.

При достижении лимита из кеша клиента вытесняется самая старая запись. Вытесненный запрос
всё ещё может быть повторно использован, так как кеш на уровне пула (`prepared_statements_cache_size`) сохраняет
соответствие запрос-имя-на-сервере.

Установите `0` для отключения лимита (неограниченный размер кеша, полагается на вызов `DEALLOCATE` клиентом).

Default: `0 (unlimited)`.

### message_size_to_be_stream

Ответы данных от сервера (тип сообщения 'D'), превышающие это значение,
передаются через прокси небольшими частями (1 МБ).

Default: `1048576`.

### max_memory_usage

Рассчитывается общий объём памяти, используемый внутренними буферами для всех текущих запросов.
При достижении лимита клиент получит ошибку (256 МБ).

Default: `268435456`.

### shutdown_timeout

При корректном завершении работы ожидаем завершения транзакций в пределах этого лимита (10 секунд).

Default: `10000`.

### proxy_copy_data_timeout

Максимальное время ожидания операций копирования данных при проксировании, в миллисекундах.

Default: `15000 (15 sec)`.

### server_tls

Включить TLS для подключений к серверу PostgreSQL. При включении pg_doorman будет пытаться установить TLS-соединения с серверами PostgreSQL.

Default: `false`.

### verify_server_certificate

Проверять TLS-сертификат сервера PostgreSQL при подключении с TLS. Настройка актуальна только при включённом `server_tls`.

Default: `false`.

### hba

Список IP-адресов, с которых разрешено подключение к pg-doorman.

Default: `[]`.

### pg_hba

Контроль доступа клиентов в формате `pg_hba.conf` PostgreSQL. Позволяет определять гибкие правила доступа, аналогичные PostgreSQL, включая правила для отдельных баз данных, пользователей, диапазонов адресов и требований TLS.

Можно указать `general.pg_hba` тремя способами:

- Многострочная строка с содержимым файла `pg_hba.conf`
- Объект с `path`, указывающим на файл на диске
- Объект с `content`, содержащим правила в виде строки

Примеры:

```toml
[general]
# Inline content (triple-quoted TOML string)
pg_hba = """
# type   database  user   address         method
host     all       all    10.0.0.0/8      md5
hostssl  all       all    0.0.0.0/0       scram-sha-256
hostnossl all      all    192.168.1.0/24  trust
"""

# Or load from file
# pg_hba = { path = "./pg_hba.conf" }

# Or embed as a single-line string
# pg_hba = { content = "host all all 127.0.0.1/32 trust" }
```

Поддерживаемые поля и методы:
- Типы подключений: `local`, `host`, `hostssl`, `hostnossl` (учитывается соответствие TLS)
- Сопоставление баз данных: имя или `all`
- Сопоставление пользователей: имя или `all`
- Адрес: в форме CIDR, например `1.2.3.4/32` или `::1/128` (обязателен для не-`local` правил)
- Методы: `trust`, `md5`, `scram-sha-256` (неизвестные методы разбираются, но считаются запрещёнными)

Приоритет и совместимость:
- `general.pg_hba` заменяет устаревший список `general.hba`. Нельзя использовать оба одновременно; валидация конфигурации отклонит такую комбинацию.
- Правила проверяются по порядку; первое подходящее правило определяет результат.

Поведение метода trust:
- Когда подходящее правило использует `trust`, PgDoorman принимает подключение без запроса пароля. Это соответствует поведению PostgreSQL.
- Если `trust` совпадает, PgDoorman пропускает проверку пароля, даже если у пользователя есть пароль `md5` или `scram-sha-256`. Это влияет на оба метода.
- Ограничения TLS правила соблюдаются: `hostssl` требует TLS, `hostnossl` запрещает TLS.

Доступ к консоли администратора:
- Правила `general.pg_hba` применяются и к специальной базе данных `pgdoorman` (админ-консоль).
- Это означает, что можно разрешить доступ с методом `trust`, если есть соответствующее правило:
  ```
  host  pgdoorman  admin  127.0.0.1/32  trust
  ```

Замечания и ограничения:
- Поддерживается только минимальное подмножество `pg_hba.conf`, достаточное для большинства сценариев прокси (тип, база данных, пользователь, адрес, метод). Дополнительные опции (вроде `clientcert`) в настоящее время игнорируются.
- Для методов аутентификации, отличных от `trust`, PgDoorman выполняет соответствующий challenge/response с клиентом.
- Для Talos/JWT/PAM, настроенных на уровне пула/пользователя, `trust` по-прежнему обходит запрос пароля; однако эти режимы могут использоваться, когда `trust` не совпадает.

### pooler_check_query

Этот запрос не отправляется на сервер, если выполняется как SimpleQuery.
Может использоваться для проверки соединения на уровне приложения.

Default: `";"`.

